context("estEffs")

## Simulate data.
set.seed(1234)
Vg <- matrix(c(6.06, 4.97, 5.96, 4.97, 4.43, 5.29, 5.96, 5.29, 6.67), nrow = 3)
Ve <- matrix(c(3.28, 0.18, 0.14, 0.18, 4.43, 0.13, 0.14, 0.13, 2.99), nrow = 3)
K <- matrix(c(0.82, 0.007, -0.035, -0.027, -0.035, -0.025, -0.051,
              -0.048, 0.025, -0.032, 0.007, 0.998, 0.025, 0.03, 0.04, 0.022,
              0.212, -0.017, -0.055, -0.011, -0.035, 0.025, 1.124, 0.342, 0.123,
              0.062, 0.097, 0.021, 0.027, -0.047, -0.027, 0.03, 0.342, 1.052,
              0.177, 0.181, 0.004, -0.017, -0.042, -0.036, -0.035, 0.04, 0.123,
              0.177, 1.057, 0.675, 0.016, -0.03, 0.019, -0.014, -0.025, 0.022,
              0.062, 0.181, 0.675, 1.062, -0.019, -0.006, 0.034, -0.009, -0.051,
              0.212, 0.097, 0.004, 0.016, -0.019, 1.136, -0.014, -0.012, -0.037,
              -0.048, -0.017, 0.021, -0.017, -0.03, -0.006, -0.014, 1.115,
              -0.021, -0.076, 0.025, -0.055, 0.027, -0.042, 0.019, 0.034, -0.012,
              -0.021, 1.197, -0.06, -0.032, -0.011, -0.047, -0.036, -0.014,
              -0.009, -0.037, -0.076, -0.06, 0.872), nrow = 10)
S <- matrixRoot(K)
V <- matrixRoot(Vg)
Z <- matrix(rnorm(n = 30), ncol = 3)
Z2 <- matrix(rnorm(n = 30), ncol = 3)
X <- matrix(sample(x = 0:2, size = 100, replace = TRUE), ncol = 10)
W <- matrix(sample(x = 1:2, size = 20, replace = TRUE), ncol = 2)
Y  <- S %*% Z %*% V + S %*% Z2
rownames(Y) <- rownames(K) <- colnames(K) <- rownames(X) <- paste0("G", 1:10)
colnames(Y) <- paste0("t", 1:3)

effs0 <- estEffs(Y = Y, X = X, Vg = Vg, Ve = Ve, K = K)
effs1 <- estEffs(Y = Y, X = X, Vg = Vg, Ve = Ve, K = K, estCom = TRUE)
test_that("estEffs produces correct output structure", {
  expect_is(effs0, "list")
  expect_length(effs0, 3)
  expect_named(effs0, c("effs", "effsSe", "pVals"))
  expect_length(effs1, 7)
  expect_named(effs1, c("effs", "effsSe", "pVals", "effsCom", "effsComSe",
                        "pValCom", "pValQtlE"))
  lapply(X = effs1[1:2], FUN = expect_is, "matrix")
  expect_equal(dim(effs1[[1]]), c(3, 10))
  expect_equal(dim(effs1[[2]]), c(3, 10))
  lapply(X = effs1[3:7], FUN = expect_is, "numeric")
  expect_equal(effs0, effs1[1:3])
})

test_that("estEffs functions properly", {
  expect_equal(as.numeric(effs1[[1]]),
               c(0.10273036683125, -0.164894480353523, -1.01433124024544,
                 0.377947552080525, 1.17814885638572, 0.9232354444654,
                 -0.745481515662282, -0.617819986645353, 1.05436018048927,
                 -1.04145450307504, -0.528513652888782, -0.672212954904309,
                 0.153004278519573, -0.387336365890314, 0.731546282433279,
                 0.036837981052964, -0.188624745138486, -0.883707982498482,
                 0.686583342156242, 0.844914960376715, 0.848952308922682,
                 -1.43613846063688, -1.13180825865606, 0.151377592990046,
                 -0.17867364549113, 0.24970134987536, -0.972333803665111,
                 -0.762636171768473, -0.0592002022318886, -0.495890453896113))
  expect_equal(as.numeric(effs1[[2]]),
               c(1.13060135876044, 1.10833417679261, 1.14725550662439,
                 1.43762273127347, 1.41591341930748, 1.45634980170863,
                 1.66506594973433, 1.60942797001076, 1.69637959138038,
                 1.10624151010933, 1.11013247883435, 1.11453481590208,
                 1.47136029580093, 1.4409537205953, 1.49287369830522,
                 1.30254217205145, 1.28597131226985, 1.31864809271626,
                 1.13167880638563, 1.12848135497375, 1.14193757691706,
                 1.4130924612978, 1.38599095755949, 1.43383607389712,
                 1.24162593743679, 1.21025640956942, 1.2617299596923,
                 1.23299501081365, 1.21387443859938, 1.24954529561097))
  expect_equal(effs1[[3]],
               c(0.202428413599706, 0.468409643388588, 0.0797283850983216,
                 0.444349880309488, 0.570234181750045, 0.528232896205788,
                 0.529063929841742, 0.0489574471756827, 0.268548845056985,
                 0.683000207729673))
  expect_equal(effs1[[4]],
               c(-0.31037806369122, 0.844360954623241, -0.238493508135944,
                 -0.742965617357643, 0.0946127439861604, -0.312341939387387,
                 0.793668851811231, -0.878876765879321, -0.213891079531014,
                 -0.411806159234075))
  expect_equal(effs1[[5]],
               c(0.954282419588967, 1.20634309610511, 1.42479716802237,
                 0.909154689377672, 1.24170116297408, 1.09035017519145,
                 0.935941410818849, 1.19243801901172, 1.05339857368155,
                 1.03593801147628))
  expect_equal(effs1[[6]],
               c(0.57541619347757, 0.222760741251156, 0.773655361540758,
                 0.152346630724879, 0.895908420051371, 0.622043196065038,
                 0.136862319925428, 0.19846120757285, 0.727088132394443,
                 0.492965301883432))
  expect_equal(effs1[[7]],
               c(0.120832503989023, 0.580090501678711, 0.0377057546203398,
                 0.706397753523179, 0.376381797257761, 0.377937423329551,
                 0.956695489824839, 0.0461379836230016, 0.153919600365982,
                 0.599100235748458))
})

test_that("option returnSe functions properly", {
  effs0a <- estEffs(Y = Y, X = X, Vg = Vg, Ve = Ve, K = K, returnSe = FALSE)
  effs1a <- estEffs(Y = Y, X = X, Vg = Vg, Ve = Ve, K = K, returnSe = FALSE,
                    estCom = TRUE)
  expect_named(effs0a, "effs")
  expect_named(effs1a, c("effs", "effsCom"))
  expect_equal(effs0a, effs0[1])
  expect_equal(effs1a, effs1[c(1, 4)])
})

test_that("option chuncks doesn't affect results", {
  effs0b <- estEffs(Y = Y, X = X, Vg = Vg, Ve = Ve, K = K, nChunks = 2)
  effs1b <- estEffs(Y = Y, X = X, Vg = Vg, Ve = Ve, K = K, estCom = TRUE,
                    nChunks = 2)
  expect_equal(effs0, effs0b)
  expect_equal(effs1, effs1b)
})

test_that("adding covariates functions properly", {
  effs0c <- estEffs(Y = Y, W = W, X = X, Vg = Vg, Ve = Ve, K = K)
  effs1c <- estEffs(Y = Y, W = W, X = X, Vg = Vg, Ve = Ve, K = K, estCom = TRUE)
  expect_equal(effs0c, effs1c[1:3])
  expect_equal(as.numeric(effs1c[[1]]),
               c(-0.33192975618025, -0.728719590799482, -1.27754004974249,
                 0.85545633897567, 1.58643917568452, 1.45812529064413,
                 -0.785257552851577, -0.994581260333615, 0.139493851796006,
                 -1.05069012061209, -0.641718186725281, -1.16222068399655,
                 0.90344943966062, 0.0552423476669457, -0.709859010609265,
                 -0.367215316812433, -0.653289884882258, -1.11024608618177,
                 0.875952802265472, 0.737400064187865, 1.13375046407743,
                 -1.62310080772408, -1.55310988880642, -0.948643218469966,
                 -0.823862526491072, -0.63209384002161, -1.16057107571553,
                 -0.877107870045166, -0.415588904157843, -0.922320875453233))
  expect_equal(as.numeric(effs1c[[2]]),
               c(1.13035472905429, 1.09905749586585, 1.14992077819223,
                 2.17187451431002, 2.10581895764964, 2.21089659874692,
                 2.28300738427203, 2.21974471169279, 2.32210898065535,
                 1.05920873261138, 1.05540492622364, 1.06932592568333,
                 1.97401663961831, 1.95268311154844, 1.99785818751559,
                 1.12033076548108, 1.10631112285172, 1.13397958144056,
                 1.34174988362943, 1.33244653610743, 1.35622156744947,
                 1.51669009236628, 1.47651483163122, 1.54205789327734,
                 1.27390589160363, 1.26383752029042, 1.28714695007577,
                 1.14469976678409, 1.12236839779378, 1.16120920775162))
  expect_equal(effs1c[[3]],
               c(0.121368227009967, 0.513875943753021, 0.663633752327044,
                 0.169941816066055, 0.417377250193738, 0.277751052817045,
                 0.465717754908765, 0.132324378795712, 0.410333044325056,
                 0.434308694007779))
  expect_equal(effs1c[[4]],
               c(-0.743748503357566, 1.31842945961284, -0.630729077583839,
                 -0.931233590906565, 0.115120292480326, -0.689602533164131,
                 0.898702146947266, -1.41652097786463, -0.849578701921098,
                 -0.705312007443737))
  expect_equal(effs1c[[5]],
               c(0.962421341294148, 1.85336553269205, 1.94282269382196,
                 0.877476321616296, 1.65041384486282, 0.937269785886646,
                 1.11654466232712, 1.28897976951739, 1.05901189184199,
                 0.965276382269))
  expect_equal(effs1c[[6]],
               c(0.145804361223665, 0.182211005114461, 0.548976287819277,
                 0.0410823788435873, 0.897933499335176, 0.167071803321656,
                 0.128993067861456, 0.0337653749407814, 0.130329210583705,
                 0.170145813456352))
  expect_equal(effs1c[[7]],
               c(0.156915600268238, 0.747938081928628, 0.545981805612185,
                 0.600229484950832, 0.251825616557708, 0.370533680451536,
                 0.841258572751533, 0.52749661146528, 0.711430082487053,
                 0.631988319054396))
})
