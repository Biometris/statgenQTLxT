context("estEffs")

## Simulate data.
set.seed(1234)
Vg <- matrix(c(6.06, 4.97, 5.96, 4.97, 4.43, 5.29, 5.96, 5.29, 6.67), nrow = 3)
Ve <- matrix(c(3.28, 0.18, 0.14, 0.18, 4.43, 0.13, 0.14, 0.13, 2.99), nrow = 3)
K <- matrix(c(0.82, 0.007, -0.035, -0.027, -0.035, -0.025, -0.051,
              -0.048, 0.025, -0.032, 0.007, 0.998, 0.025, 0.03, 0.04, 0.022,
              0.212, -0.017, -0.055, -0.011, -0.035, 0.025, 1.124, 0.342, 0.123,
              0.062, 0.097, 0.021, 0.027, -0.047, -0.027, 0.03, 0.342, 1.052,
              0.177, 0.181, 0.004, -0.017, -0.042, -0.036, -0.035, 0.04, 0.123,
              0.177, 1.057, 0.675, 0.016, -0.03, 0.019, -0.014, -0.025, 0.022,
              0.062, 0.181, 0.675, 1.062, -0.019, -0.006, 0.034, -0.009, -0.051,
              0.212, 0.097, 0.004, 0.016, -0.019, 1.136, -0.014, -0.012, -0.037,
              -0.048, -0.017, 0.021, -0.017, -0.03, -0.006, -0.014, 1.115,
              -0.021, -0.076, 0.025, -0.055, 0.027, -0.042, 0.019, 0.034, -0.012,
              -0.021, 1.197, -0.06, -0.032, -0.011, -0.047, -0.036, -0.014,
              -0.009, -0.037, -0.076, -0.06, 0.872), nrow = 10)
S <- as.matrix(matrixRoot(K))
V <- as.matrix(matrixRoot(Vg))
Z <- matrix(rnorm(n = 30), ncol = 3)
Z2 <- matrix(rnorm(n = 30), ncol = 3)
X <- matrix(sample(x = 0:2, size = 100, replace = TRUE), ncol = 10)
W <- matrix(sample(x = 1:2, size = 20, replace = TRUE), ncol = 2)
Y  <- S %*% Z %*% V + S %*% Z2
rownames(Y) <- rownames(K) <- colnames(K) <- rownames(X) <- paste0("G", 1:10)
colnames(Y) <- paste0("t", 1:3)

effs0 <- estEffsCPP(y = Y, w = W[, 1, drop = FALSE], x = X,
                    vg = Vg, ve = Ve, k = K)
effs1 <- estEffsCPP(y = Y, w = W[, 1, drop = FALSE], x = X,
                    vg = Vg, ve = Ve, k = K, estCom = TRUE)
test_that("estEffsCPP produces correct output structure", {
  expect_is(effs0, "list")
  expect_length(effs0, 7)
  expect_named(effs0, c("effs", "effsSe", "pVals", "effsCom", "effsComSe",
                        "pValsCom", "pValsQtlE"))
  expect_length(effs1, 7)
  expect_named(effs1, c("effs", "effsSe", "pVals", "effsCom", "effsComSe",
                        "pValsCom", "pValsQtlE"))
  lapply(X = effs1[1:2], FUN = expect_is, "matrix")
  expect_equal(dim(effs1[[1]]), c(3, 10))
  expect_equal(dim(effs1[[2]]), c(3, 10))
  lapply(X = effs1[3:7], FUN = expect_is, "numeric")
  expect_equal(effs0[1:3], effs1[1:3])
})

test_that("estEffsCPP functions properly", {
  expect_equivalent(effs1[[1]],
               c(-0.260111188325187, -0.400576717739155, -1.3455394164809,
                 0.195658303214135, 0.835486675159198, -0.392774054924572,
                 -0.776842934516871, -0.762039515840775, -0.470274357388467,
                 -1.0112387575209, -0.564946830679194, -1.21785872153534,
                 0.757213805557279, -0.176806052425039, 0.218770937544865,
                 -0.361619513415116, -0.453784962632141, -1.32914726056457,
                 0.498815392166474, 0.635543147028271, 0.114452026087414,
                 -1.39231679432142, -1.14323108899273, -1.30372910519222,
                 -0.572366290434635, -0.243414897406562, -1.29163079739488,
                 -0.80760120993806, -0.276060584387631, -1.15817020177477))
  expect_equivalent(effs1[[2]],
               c(0.948042513123553, 0.927302609323049, 0.962636950949932,
                 1.31694980491006, 1.29348131315563, 1.33531419416029,
                 2.15396267257989, 2.09913816074297, 2.18959141346548,
                 1.05725374338911, 1.05185149999838, 1.06774317517271,
                 1.70175759772862, 1.68919063378029, 1.71985423851557,
                 1.0719763234403, 1.04546187799458, 1.08883800386415,
                 1.05739159003792, 1.05191342140648, 1.06784571174672,
                 1.381846011272, 1.34214885522443, 1.40573602847897,
                 0.994628819566588, 0.964882091731461, 1.0120506524886,
                 1.09134414637582, 1.06406912196658, 1.1089886663834))
  expect_equivalent(effs1[[3]],
                    c(0.0273860352528435, 0.346033238049085, 0.913843393633836,
                      0.193531192856533, 0.792880996039304, 0.1085146144959,
                      0.655627161522645, 0.285830758725634, 0.0757121174364365,
                      0.236266140831248))
  expect_equivalent(effs1[[4]],
                    c(-0.610633898368438, 0.285990327721489, -0.689588444201817,
                      -0.904769402171983, 0.246732476742135, -0.65812526459816,
                      0.436869496092449, -1.26524464466809, -0.620034777292898,
                      -0.682985185092064))
  expect_equivalent(effs1[[5]],
                    c(0.802037554325757, 1.10864148617941, 1.8293202770379,
                      0.877134674736958, 1.41559184345636, 0.908178278374482,
                      0.877167188363869, 1.17665310863784, 0.847622721721427,
                      0.925796511346878))
  expect_equivalent(effs1[[6]],
                    c(0.175565377309115, 0.651487360773368, 0.508239902117815,
                      0.0622508194636007, 0.760472398762899, 0.198083378868712,
                      0.380528626382848, 0.0512092812219991, 0.193745824799329,
                      0.189849659350822))
  expect_equivalent(effs1[[7]],
                    c(0.0267313689965197, 0.217198576894496, 0.950980200753633,
                      0.507700692441234, 0.629250045848274, 0.111540335562664,
                      0.650258139964503, 0.936067165103609, 0.0758004297747845,
                      0.280391468184679))
})

test_that("option returnSe functions properly", {
  effs0a <- estEffsCPP(y = Y, w = W[, 1, drop = FALSE], x = X,
                       vg = Vg, ve = Ve, k = K, returnSe = FALSE)
  effs1a <- estEffsCPP(y = Y, w = W[, 1, drop = FALSE], x = X,
                       vg = Vg, ve = Ve, k = K, returnSe = FALSE, estCom = TRUE)
  expect_true(all(effs0a[[2]] == 0))
  expect_true(all(effs0a[[3]] == 0))
  expect_true(all(effs0a[[4]] == 0))
  expect_true(all(effs1a[[2]] == 0))
  expect_true(all(effs1a[[3]] == 0))
  expect_equal(effs0a[1], effs0[1])
  expect_equal(effs1a[c(1, 4)], effs1[c(1, 4)])
})

test_that("adding covariates functions properly", {
  effs0c <- estEffsCPP(y = Y, w = W, x = X, vg = Vg, ve = Ve, k = K)
  effs1c <- estEffsCPP(y = Y, w = W, x = X, vg = Vg,
                       ve = Ve, k = K, estCom = TRUE)
  expect_equal(effs0c[1:3], effs1c[1:3])
  expect_equivalent(effs1c[[1]],
                    c(-0.331929756180253, -0.728719590799485, -1.27754004974249,
                      0.855456338975692, 1.58643917568452, 1.45812529064414,
                      -0.78525755285158, -0.994581260333617, 0.139493851795996,
                      -1.05069012061209, -0.641718186725281, -1.16222068399655,
                      0.903449439660619, 0.0552423476669524, -0.709859010609267,
                      -0.367215316812437, -0.65328988488226, -1.11024608618177,
                      0.87595280226548, 0.737400064187871, 1.13375046407744,
                      -1.62310080772408, -1.55310988880643, -0.948643218469971,
                      -0.823862526491071, -0.632093840021608, -1.16057107571553,
                      -0.877107870045162, -0.415588904157839, -0.922320875453231))
  expect_equivalent(effs1c[[2]],
                    c(1.13035472905429, 1.09905749586585, 1.14992077819223,
                      2.17187451431003, 2.10581895764964, 2.21089659874693,
                      2.28300738427204, 2.2197447116928, 2.32210898065535,
                      1.05920873261138, 1.05540492622364, 1.06932592568333,
                      1.97401663961832, 1.95268311154846, 1.9978581875156,
                      1.12033076548108, 1.10631112285172, 1.13397958144056,
                      1.34174988362943, 1.33244653610744, 1.35622156744947,
                      1.51669009236628, 1.47651483163122, 1.54205789327734,
                      1.27390589160363, 1.26383752029042, 1.28714695007577,
                      1.14469976678409, 1.12236839779378, 1.16120920775162))
  expect_equivalent(effs1c[[3]],
                    c(0.121368227009968, 0.513875943753013, 0.663633752327032,
                      0.169941816066058, 0.417377250193734, 0.277751052817055,
                      0.465717754908775, 0.132324378795716, 0.41033304432506,
                      0.434308694007785))
  expect_equivalent(effs1c[[4]],
                    c(-4.0206304455418, 1.35753269653476, 1.39998162322702,
                      -5.11703151641918, 8.87738044798178, 5.66959545926419,
                      1.43072590018557, 1.49357324724238, -1.60952831324516,
                      -49.0276395121936))
  expect_equivalent(effs1c[[5]],
                    c(1.30235635943621, NaN, NaN, 1.45164191464607, NaN, NaN,
                      NaN, NaN, 1.04029149194919, 4.61093315566282))
  expect_equivalent(effs1c[[6]],
                    c(1, 1, 1, 1, 1, 1, 1, 1, 0.00153415841774731, 1))
  expect_equivalent(effs1c[[7]],
                    c(1, 0.00513696068345047, 0.0313919147743953, 1,
                      5.91614877777529e-05, 2.29648597707031e-07,
                      0.00489923608146106, 0.00175101595193798, 1, 1))
})
